--
-- 1. 行程主表 (trips)
-- 用於儲存每個行程的概要資訊
--
CREATE TABLE IF NOT EXISTS public.trips (
    id uuid NOT NULL DEFAULT gen_random_uuid(),
    created_at timestamp with time zone NOT NULL DEFAULT now(),
    owner_id uuid REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
    title text NOT NULL,
    start_date date NOT NULL,
    end_date date NOT NULL,
    base_currency text NOT NULL DEFAULT 'TWD',
    region text NULL,
    CONSTRAINT trips_pkey PRIMARY KEY (id)
);

-- 啟用 RLS
ALTER TABLE public.trips ENABLE ROW LEVEL SECURITY;

-- 只有行程成員可以讀取行程
CREATE POLICY "Select policy for trip members"
ON public.trips FOR SELECT
USING (
    EXISTS (
        SELECT 1 
        FROM public.trip_members 
        WHERE trip_members.trip_id = trips.id 
        AND trip_members.user_id = auth.uid()
    )
);

-- 只有行程擁有者可以建立行程
CREATE POLICY "Insert policy for trip owner"
ON public.trips FOR INSERT
WITH CHECK (
    auth.uid() = owner_id
);


--
-- 2. 行程成員表 (trip_members)
-- 支援未來共同規劃功能，並作為 RLS 的依據
--
CREATE TABLE IF NOT EXISTS public.trip_members (
    id uuid NOT NULL DEFAULT gen_random_uuid(),
    created_at timestamp with time zone NOT NULL DEFAULT now(),
    trip_id uuid REFERENCES public.trips(id) ON DELETE CASCADE NOT NULL,
    user_id uuid REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
    role text NOT NULL DEFAULT 'member', -- 'owner', 'member'
    CONSTRAINT trip_members_pkey PRIMARY KEY (id)
);

-- 啟用 RLS
ALTER TABLE public.trip_members ENABLE ROW LEVEL SECURITY;

-- 所有成員可以讀取成員列表
CREATE POLICY "Allow members to view members list"
ON public.trip_members FOR SELECT
USING (auth.uid() = user_id OR EXISTS (
    SELECT 1 FROM public.trip_members tm2 
    WHERE tm2.trip_id = trip_members.trip_id AND tm2.user_id = auth.uid()
));

-- 任何人都可以新增自己作為成員 (通常與 trips INSERT 一起執行)
CREATE POLICY "Allow authenticated user to insert own membership"
ON public.trip_members FOR INSERT
WITH CHECK (auth.uid() = user_id);


--
-- 3. 行程項目/景點表 (itinerary_items)
-- 儲存每日的景點、活動細節 (Option E)
--
CREATE TABLE IF NOT EXISTS public.itinerary_items (
    id uuid NOT NULL DEFAULT gen_random_uuid(),
    created_at timestamp with time zone NOT NULL DEFAULT now(),
    tripId uuid REFERENCES public.trips(id) ON DELETE CASCADE NOT NULL,
    date date NOT NULL,
    name text NOT NULL,
    startTime text NOT NULL, -- 由於是 TimeOfDay 格式，使用 text
    sortIndex integer NOT NULL DEFAULT 0,
    description text NULL,
    endTime text NULL,
    address text NULL,
    CONSTRAINT itinerary_items_pkey PRIMARY KEY (id)
);

-- 啟用 RLS
ALTER TABLE public.itinerary_items ENABLE ROW LEVEL SECURITY;

-- 只有行程成員可以讀取景點
CREATE POLICY "Select policy for itinerary items"
ON public.itinerary_items FOR SELECT
USING (EXISTS (
    SELECT 1 FROM public.trip_members 
    WHERE trip_members.trip_id = itinerary_items.tripId AND trip_members.user_id = auth.uid()
));

-- 只有行程成員可以新增景點
CREATE POLICY "Insert policy for itinerary items"
ON public.itinerary_items FOR INSERT
WITH CHECK (EXISTS (
    SELECT 1 FROM public.trip_members 
    WHERE trip_members.trip_id = itinerary_items.tripId AND trip_members.user_id = auth.uid()
));
